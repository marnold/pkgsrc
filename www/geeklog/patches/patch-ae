$NetBSD: patch-ae,v 1.1.1.1 2006/06/15 13:26:44 taca Exp $

--- public_html/admin/group.php.orig	2006-05-28 18:41:40.000000000 +0900
+++ public_html/admin/group.php
@@ -556,6 +556,7 @@ function getGroupList ($basegroup)
 function listusers ($grp_id)
 {
     global $_CONF, $_TABLES, $LANG28, $LANG_ACCESS, $LANG_ADMIN, $_IMAGE_TYPE;
+
     require_once( $_CONF['path_system'] . 'lib-admin.php' );
     $retval = '';
 
@@ -602,7 +603,7 @@ function listusers ($grp_id)
                        'title'        => $headline,
                        'instructions' => '',
                        'icon'         => '',
-                       'form_url'     => '',
+                       'form_url'     => $_CONF['site_admin_url'] . '/group.php?mode=listusers&grp_id=23',
                        'help_url'     => ''
     );
 
@@ -616,17 +617,21 @@ function listusers ($grp_id)
     $groups = getGroupList ($grp_id);
     $groupList = implode (',', $groups);
 
-    $sql = "SELECT DISTINCT {$_TABLES['users']}.uid,username,fullname,email,photo,regdate$select_userinfo FROM {$_TABLES['users']},{$_TABLES['group_assignments']} $join_userinfo WHERE {$_TABLES['users']}.uid > 1 AND {$_TABLES['users']}.uid = {$_TABLES['group_assignments']}.ug_uid AND ({$_TABLES['group_assignments']}.ug_main_grp_id IN ({$groupList}))";
+    $sql = "SELECT DISTINCT {$_TABLES['users']}.uid,username,fullname,email,photo,regdate$select_userinfo "
+          ."FROM {$_TABLES['group_assignments']},{$_TABLES['users']} $join_userinfo "
+          ."WHERE {$_TABLES['users']}.uid > 1 "
+          ."AND {$_TABLES['users']}.uid = {$_TABLES['group_assignments']}.ug_uid " 
+          ."AND ({$_TABLES['group_assignments']}.ug_main_grp_id IN ({$groupList}))";
 
     $query_arr = array ('table' => 'users',
                         'sql' => $sql,
                         'query_fields' => array('username', 'email', 'fullname'),
                         'default_filter' => "AND {$_TABLES['users']}.uid > 1",
-                        'query' => $_REQUEST['q'],
+                        'query' => COM_applyFilter($_REQUEST['q']),
                         'query_limit' => COM_applyFilter ($_REQUEST['query_limit'], true)
     );
 
-    $retval .= ADMIN_list ('user', 'ADMIN_getListField_users', $header_arr, $text_arr, $query_arr, array(), $defsort_arr, "&mode=listusers&grp_id=$grp_id");
+    $retval .= ADMIN_list ('user', 'ADMIN_getListField_users', $header_arr, $text_arr, $query_arr, array(), $defsort_arr, "", "&mode=listusers&grp_id=$grp_id");
 
     return $retval;
 }
