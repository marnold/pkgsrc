# $NetBSD: Makefile.module,v 1.15.2.1 2002/06/21 23:02:53 jlam Exp $
#
# This Makefile is provided to ease creating PHP4 packages for the extension
# modules distributed in the PHP4 sources.
#
# Just include this file, define MODNAME, define PKGREVISION if necessary,
# add dependencies, and add the appropriate --with-configure-arg, then include
# bsd.pkg.mk.

.include "../../www/php4/Makefile.common"

PKGNAME?=		php-${MODNAME}-${PHP_BASE_VERS}
PKGREVISION?=		# empty

BUILD_DEPENDS+=		automake>=1.4:../../devel/automake
DEPENDS+=		php>=${PHP_BASE_VERS}:../../www/php4

PKGMODNAME?=		${MODNAME:S/-/_/}
MODULESDIR?=		${WRKSRC}/modules
PLIST_SUBST+=		MODNAME=${PKGMODNAME}

EXTRACT_ELEMENTS?=	${DISTNAME}/ext/${PKGMODNAME}
WRKSRC?=		${WRKDIR}/${EXTRACT_ELEMENTS}

PHPIZE?=		${BUILDLINK_PREFIX.php4}/bin/phpize
PHP_CONFIG?=		${BUILDLINK_PREFIX.php4}/bin/php-config

GNU_CONFIGURE=		YES
CONFIGURE_ARGS+=	--with-php-config=${PHP_CONFIG}

USE_CONFIG_WRAPPER=	YES
USE_LIBTOOL=		YES
LTCONFIG_OVERRIDE=	${WRKSRC}/ltconfig

# Ensure we export symbols in the linked shared objects.
LDFLAGS+=		-Wl,--export-dynamic

PLIST_SRC=		${.CURDIR}/../../www/php4/PLIST.module
MESSAGE_SRC=		${.CURDIR}/../../www/php4/MESSAGE.module
MESSAGE_SUBST+=		MODNAME=${PKGMODNAME}
MESSAGE_SUBST+=		PHP_EXTENSION_DIR=${PHP_EXTENSION_DIR}

pre-configure:	phpize-module

phpize-module:
	@cookie=${WRKDIR}/.phpize_module_done;				\
	if [ ! -f $${cookie} ]; then					\
		( cd ${WRKSRC} && ${PHPIZE} );				\
		${TOUCH} ${TOUCH_FLAGS} $${cookie};			\
	fi

do-install: do-module-install

do-module-install:
	${INSTALL_DATA_DIR} ${PREFIX}/${PHP_EXTENSION_DIR}
	${INSTALL_DATA} ${MODULESDIR}/${PKGMODNAME}.so \
		${PREFIX}/${PHP_EXTENSION_DIR}

.include "../../www/php4/buildlink2.mk"
