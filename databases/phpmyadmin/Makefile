# $NetBSD: Makefile,v 1.29.2.1 2005/04/04 14:07:10 salo Exp $

DISTNAME=	phpMyAdmin-${DIST_VERSION}
PKGNAME=	phpmyadmin-${DIST_VERSION:S/-//}
CATEGORIES=	databases www
MASTER_SITES=	${MASTER_SITE_SOURCEFORGE:=phpmyadmin/}
EXTRACT_SUFX=	.tar.bz2

MAINTAINER=	tron@NetBSD.org
HOMEPAGE=	http://www.phpmyadmin.net/
COMMENT=	Set of PHP-scripts to adminstrate MySQL over the WWW

DEPENDS+=	php-mbstring{,i}>=4.3.3:../../misc/php-mbstring
DEPENDS+=	php-mysql{,i}>=4.3.3:../../databases/php-mysql

PLIST_SUBST+=	CP="${CP}" DIST_VERSION=${DIST_VERSION} \
		PMCONFFILE=${PMCONFFILE} TEST="${TEST}"
MESSAGE_SUBST+=	PKG_SYSCONFDIR=${PKG_SYSCONFDIR} PMCONFFILE=${PMCONFFILE} \
		PMDIR=${PMDIR} EXDIR=${EXDIR}

CONF_INC_PHP=	${PREFIX}/share/phpmyadmin/config.inc.php
DIST_VERSION=	2.6.2-rc1
DOC_FILES=	CREDITS ChangeLog \
		Documentation.txt INSTALL LICENSE README \
		RELEASE-DATE-${DIST_VERSION} TODO

APACHE_USER?=	www
EXDIR=		${PREFIX}/share/examples/phpmyadmin
PMCONFFILE=	${PKG_SYSCONFDIR}/config.inc.php
PMDIR=		${PREFIX}/share/phpmyadmin
NO_BUILDLINK=	YES
CONF_FILES=	${EXDIR}/config.inc.php ${PKG_SYSCONFDIR}/config.inc.php
SPECIAL_PERMS=	${PKG_SYSCONFDIR}/config.inc.php ${APACHE_USER} wheel 0600
BUILD_DEFS+=	APACHE_USER

USE_PKGINSTALL=		YES
PKG_SYSCONFSUBDIR?=	phpmyadmin

SUBST_CLASSES=		paths
SUBST_STAGE.paths=	post-extract
SUBST_FILES.paths=	${WRKDIR}/phpmyadmin.conf	
SUBST_SED.paths=	-e "s|@PMDIR@|${PMDIR}|g"
SUBST_MESSAGE.paths=	"Fixing paths."

NO_BUILD=		# defined
NO_CONFIGURE=		# defined

INSTALL_DIRS=	css lang libraries libraries/auth libraries/dbg \
		libraries/dbi libraries/export libraries/fpdf	\
		libraries/fpdf/font libraries/transformations	\
		themes themes/darkblue_orange \
		themes/darkblue_orange/css themes/darkblue_orange/img \
		themes/original themes/original/css themes/original/img

pre-extract:
	@${CP} ${FILESDIR}/phpmyadmin.conf ${WRKDIR}/phpmyadmin.conf

do-install:
	${INSTALL_DATA_DIR} ${PREFIX}/share/doc/phpmyadmin
	${INSTALL_DATA_DIR} ${PREFIX}/share/examples/phpmyadmin
	${INSTALL_DATA_DIR} ${PMDIR}
	for dir in ${INSTALL_DIRS}; do \
		${INSTALL_DATA_DIR} ${PMDIR}/$$dir; \
	done
	${INSTALL_DATA_DIR} ${PMDIR}/scripts

	${RM} -f ${CONF_INC_PHP}	# just in case
	${INSTALL_DATA} ${WRKSRC}/*.php ${PMDIR}
	${INSTALL_DATA} ${WRKSRC}/*.css ${PMDIR}
	${MV} ${CONF_INC_PHP} ${EXDIR}
	${LN} -s ${PMCONFFILE} ${CONF_INC_PHP}

	${INSTALL_DATA} ${WRKSRC}/Documentation.html ${PMDIR}
	${INSTALL_DATA} ${WRKSRC}/translators.html ${PMDIR}
	${INSTALL_DATA}	${WRKSRC}/ChangeLog ${PMDIR}

	for dir in ${INSTALL_DIRS}; do					\
		for file in "${WRKSRC}/$$dir"/*; do			\
			${TEST} -f "$$file" -a `${BASENAME} "$$file" .sh` = `${BASENAME} "$$file"` &&				\
			${INSTALL_DATA} $$file ${PMDIR}/$$dir;		\
		done							\
	done

	${INSTALL_DATA} ${WRKSRC}/scripts/*.sql ${PMDIR}/scripts
	${INSTALL_SCRIPT} ${WRKSRC}/scripts/convertcfg.pl ${PMDIR}/scripts

	cd ${WRKSRC} && \
	${INSTALL_DATA} ${DOC_FILES} ${PREFIX}/share/doc/phpmyadmin
	${INSTALL_DATA} ${WRKDIR}/phpmyadmin.conf ${EXDIR}/apache.conf

.include "../../mk/bsd.pkg.mk"
