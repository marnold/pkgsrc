$NetBSD: patch-ac,v 1.1.1.1 2004/11/10 08:19:46 martin Exp $

--- linux2300.c.orig	2004-04-23 17:36:58.000000000 +0200
+++ linux2300.c	2004-11-08 09:33:56.000000000 +0100
@@ -13,6 +13,7 @@
 #ifndef WIN32
 #define DEBUG 0
 
+#include <errno.h>
 #include "rw2300.h"
 
 /********************************************************************
@@ -84,7 +85,7 @@
 		exit(0);
 	}
 
-	tcflush(ws2300, TCIFLUSH);
+	tcflush(ws2300, TCIOFLUSH);
 
 	// Set DTR low and RTS high and leave other ctrl lines untouched
 
@@ -149,7 +150,7 @@
 
 		usleep(50000 * i);   //we sleep longer and longer for each retry
 	}
-	printf("\nCould not reset\n");
+	fprintf(stderr, "\nCould not reset\n");
 	exit(0);
 }
 
@@ -168,7 +169,14 @@
  ********************************************************************/
 int read_device(WEATHERSTATION serdevice, unsigned char *buffer, int size)
 {
-	return read(serdevice, buffer, size);
+	int ret;
+
+	for (;;) {
+		ret = read(serdevice, buffer, size);
+		if (ret == 0 && errno == EINTR)
+			continue;
+		return ret;
+	}
 }
 
 /********************************************************************
@@ -184,7 +192,9 @@
  ********************************************************************/
 int write_device(WEATHERSTATION serdevice, unsigned char *buffer, int size)
 {
-	return write(serdevice, buffer, size);
+	int ret = write(serdevice, buffer, size);
+	tcdrain(serdevice);	// wait for all output written
+	return ret;
 }
 
 /********************************************************************
