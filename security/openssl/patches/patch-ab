$NetBSD: patch-ab,v 1.11.26.1 2008/06/05 12:24:00 rtr Exp $

--- ssl/s3_clnt.c.orig	2007-08-31 02:28:51.000000000 +0200
+++ ssl/s3_clnt.c
@@ -1967,6 +1967,13 @@ int ssl3_send_client_key_exchange(SSL *s
 			{
 			DH *dh_srvr,*dh_clnt;
 
+			if (s->session->sess_cert == NULL) 
+				{
+				ssl3_send_alert(s,SSL3_AL_FATAL,SSL_AD_UNEXPECTED_MESSAGE);
+				SSLerr(SSL_F_SSL3_SEND_CLIENT_KEY_EXCHANGE,SSL_R_UNEXPECTED_MESSAGE);
+				goto err;
+				}
+
 			if (s->session->sess_cert->peer_dh_tmp != NULL)
 				dh_srvr=s->session->sess_cert->peer_dh_tmp;
 			else
