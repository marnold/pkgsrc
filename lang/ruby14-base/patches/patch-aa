$NetBSD: patch-aa,v 1.1.1.1 2001/06/30 08:25:48 taca Exp $

--- configure.in.orig	Sat Jul 29 00:52:49 2000
+++ configure.in
@@ -26,6 +26,8 @@
 fi
 
 AC_CANONICAL_HOST
+AC_CANONICAL_TARGET
+AC_CANONICAL_BUILD
 
 dnl checks for fat-binary
 fat_binary=no
@@ -198,7 +200,7 @@
 	      truncate chsize times utimes fcntl lockf setitimer\
 	      setruid seteuid setreuid setrgid setegid setregid\
 	      getpgrp setpgrp getpgid setpgid getgroups getpriority\
-	      dlopen sigprocmask sigaction _setjmp setsid)
+	      dlopen sigprocmask sigaction _setjmp setsid mkstemp)
 AC_STRUCT_TIMEZONE
 if test "$ac_cv_func_strftime" = no; then
     AC_TRY_LINK([],
@@ -412,12 +414,7 @@
     human*)	;;
     bsdi*)	;;
     cygwin*)	;;
-    netbsd*) CCDLFLAGS=-fpic
-     case "$host_cpu" in
-     mips*) CCDLFLAGS=-fPIC ;;
-     sparc) CCDLFLAGS=-fPIC ;;
-     *) ;;
-     esac ;;
+    netbsd*) CCDLFLAGS=-fPIC;;
     *) CCDLFLAGS=-fPIC;;
     esac
   else
@@ -462,10 +459,8 @@
 			  test "$GCC" = yes && `$CC --print-prog-name=ld` -v 2>&1 | grep "GNU ld" > /dev/null || LDSHARED="ld -Bshareable"
 			fi
 			rb_cv_dlopen=yes ;;
-	netbsd*)	LDSHARED="ld -shared"
-			if test "$rb_cv_binary_elf" = yes; then
-                          LDFLAGS="-export-dynamic"
-			fi
+	netbsd*)	LDSHARED='${CC} -shared'
+			LDFLAGS=""
 			rb_cv_dlopen=yes ;;
 	openbsd*) 	LDSHARED="ld -Bforcearchive -Bshareable"
 			rb_cv_dlopen=yes ;;
@@ -716,11 +711,14 @@
 	fi
 	;;
     netbsd*)
-	LIBRUBY_SO='lib$(RUBY_INSTALL_NAME).so.$(MAJOR).$(MINOR)'
+	LIBRUBY_SO='lib$(RUBY_INSTALL_NAME).so.$(MAJOR)$(MINOR).$(TEENY)'
+	LIBRUBY_DLDFLAGS='-Wl,-soname,lib$(RUBY_INSTALL_NAME).so.$(MAJOR)$(MINOR)'
 	if test "$rb_cv_binary_elf" = yes; then # ELF platforms
-	   LIBRUBY_ALIASES='lib$(RUBY_INSTALL_NAME).so.$(MAJOR) lib$(RUBY_INSTALL_NAME).so'
-	else
-	   LIBRUBY_ALIASES=   # a.out platforms
+	   LIBRUBY_ALIASES='lib$(RUBY_INSTALL_NAME).so.$(MAJOR)$(MINOR) lib$(RUBY_INSTALL_NAME).so'
+	   LIBRUBYARG='-Wl,--rpath -Wl,${prefix}/lib -L${prefix}/lib -L. -l$(RUBY_INSTALL_NAME) -Wl,--rpath -Wl,${X11BASE}/lib -L${X11BASE}/lib'
+	else	# a.out platforms
+	   LIBRUBY_ALIASES=""
+	   LIBRUBYARG='-Wl,-R${prefix}/lib -L${prefix}/lib -L. -l$(RUBY_INSTALL_NAME) -Wl,-R${X11BASE}/lib -L${X11BASE}/lib'
 	fi
  	;;
     solaris*)
@@ -758,6 +756,9 @@
 fi
 
 case "$host_os" in
+	netbsd*)
+    	CFLAGS="$CFLAGS -pipe"
+		;;
 	nextstep*)
     	CFLAGS="$CFLAGS -pipe"
 		;;
@@ -774,6 +775,7 @@
 		;;	
 esac
 
+AC_SUBST(X11BASE)
 AC_SUBST(LIBRUBY_LDSHARED)
 AC_SUBST(LIBRUBY_DLDFLAGS)
 AC_SUBST(RUBY_INSTALL_NAME)
