$NetBSD: patch-aa,v 1.1.1.1 2002/08/25 19:40:16 gson Exp $

--- Makefile.orig	Mon Jan 21 19:59:08 2002
+++ Makefile
@@ -86,6 +86,7 @@
               irix-64-debug irix-64-optimized       \
               linux-debug linux-optimized           \
               linux-ia64-debug linux-ia64-optimized \
+              netbsd-debug netbsd-optimized	    \
               openbsd-debug openbsd-optimized       \
               osf1-debug osf1-optimized             \
               solaris-debug solaris-optimized
@@ -148,6 +149,13 @@
 OTHER_FLAGS = -Wall
 endif
 
+ifeq ($(OS), NETBSD)
+OTHER_FLAGS = -Wall
+TARGETDIR   = .
+# The following is a lie; we do build dynamic libraries
+STATIC_ONLY = yes
+endif
+
 ifeq ($(OS), OPENBSD)
 SFLAGS      = -fPIC
 LDFLAGS     = -shared -soname=$(SONAME) -lc
@@ -203,14 +211,14 @@
 
 CFLAGS      += $(DEFINES) $(OTHER_FLAGS)
 
-OBJS        = $(TARGETDIR)/sched.o \
-              $(TARGETDIR)/stk.o   \
-              $(TARGETDIR)/sync.o  \
-              $(TARGETDIR)/key.o   \
-              $(TARGETDIR)/io.o
+OBJS        = $(TARGETDIR)/sched.lo \
+              $(TARGETDIR)/stk.lo   \
+              $(TARGETDIR)/sync.lo  \
+              $(TARGETDIR)/key.lo   \
+              $(TARGETDIR)/io.lo
 OBJS        += $(EXTRA_OBJS)
 HEADER      = $(TARGETDIR)/st.h
-SLIBRARY    = $(TARGETDIR)/libst.a
+SLIBRARY    = $(TARGETDIR)/libst.la
 DLIBRARY    = $(TARGETDIR)/libst.$(DSO_SUFFIX).$(VERSION)
 EXAMPLES    = examples
 
@@ -248,8 +256,7 @@
 	if [ ! -d $(TARGETDIR) ]; then mkdir $(TARGETDIR); fi
 
 $(SLIBRARY): $(OBJS)
-	$(AR) $(ARFLAGS) $@ $(OBJS)
-	$(RANLIB) $@
+	${LIBTOOL} --mode=link ${CC} -o $@ ${OBJS} -rpath ${PREFIX}/lib -version-info 1:3
 	rm -f obj; $(LN) $(LNFLAGS) $(TARGETDIR) obj
 
 $(DLIBRARY): $(OBJS:%.o=%-pic.o)
@@ -261,11 +268,11 @@
 	rm -f $@
 	cp public.h $@
 
-$(TARGETDIR)/%asm.o: %asm.S
-	$(CC) $(CFLAGS) -c $< -o $@
+$(TARGETDIR)/%asm.lo: %asm.S
+	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c $< -o $@
 
-$(TARGETDIR)/%.o: %.c common.h md.h
-	$(CC) $(CFLAGS) -c $< -o $@
+$(TARGETDIR)/%.lo: %.c common.h md.h
+	$(LIBTOOL) --mode=compile $(CC) $(CFLAGS) -c $< -o $@
 
 examples::
 	@cd $@; $(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS)" OS="$(OS)" TARGETDIR="$(TARGETDIR)"
@@ -330,6 +337,11 @@
 	$(MAKE) OS="LINUX_IA64" BUILD="DBG"
 linux-ia64-optimized:
 	$(MAKE) OS="LINUX_IA64" BUILD="OPT"
+
+netbsd-debug:
+	$(MAKE) OS="NETBSD" BUILD="DBG"
+netbsd-optimized:
+	$(MAKE) OS="NETBSD" BUILD="OPT"
 
 openbsd-debug:
 	$(MAKE) OS="OPENBSD" BUILD="DBG"
